{% extends "base.html" %}
{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive/analytics.css') }}">
{% endblock %}
{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞{% endblock %}
{% block content %}

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
            <a href="{{ url_for('main.export_analytics') }}" 
               class="btn btn-success" 
               title="–í—ã–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ CSV"
               data-bs-toggle="tooltip">
                <i class="bi bi-filetype-csv"></i> –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
            </a>
        </div>

        {% if has_data %}
            <script type="application/json" id="expenseData">{{ category_data|tojson }}</script>
            <script type="application/json" id="incomeData">{{ income_data|tojson }}</script>

            <div class="row mb-4">
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h4 class="card-title">–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h4>
                            {% if category_data %}
                                <div style="position: relative; height: 300px;">
                                    <canvas id="expenseChart"></canvas>
                                </div>
                            {% else %}
                                <p class="text-muted mt-3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h4 class="card-title">–î–æ—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h4>
                            {% if income_data %}
                                <div style="position: relative; height: 300px;">
                                    <canvas id="incomeChart"></canvas>
                                </div>
                            {% else %}
                                <p class="text-muted mt-3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ—Ö–æ–¥–∞—Ö –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-8 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title mb-3">–ë—é–¥–∂–µ—Ç—ã</h4>
                            {% if budget_status %}
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                            <th>–õ–∏–º–∏—Ç</th>
                                            <th>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</th>
                                            <th>–û—Å—Ç–∞—Ç–æ–∫</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for b in budget_status %}
                                            <tr>
                                                <td>{{ b.category }}</td>
                                                <td>{{ "%.2f"|format(b.limit|float) }}‚ÇΩ</td>
                                                <td>{{ "%.2f"|format(b.spent|float) }}‚ÇΩ</td>
                                                <td class="{{ 'text-success' if b.remaining >= 0 else 'text-danger' }}">
                                                    {{ "%.2f"|format(b.remaining|float) }}‚ÇΩ
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% else %}
                                <p class="text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—é–¥–∂–µ—Ç–æ–≤</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h4 class="card-title">–°—á–µ—Ç–∞</h4>
                            {% if accounts %}
                                <ul class="list-group">
                                    {% for account in accounts %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            {{ account.name }}
                                            <span class="badge bg-primary rounded-pill">
                                                {{ account.balance }} {{ account.currency }}
                                            </span>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—á–µ—Ç–æ–≤</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">–¶–µ–ª–∏</h4>
                            {% if goals %}
                                <div class="list-group">
                                    {% for goal in goals %}
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between mb-2">
                                                <strong>{{ goal.name }}</strong>
                                                <span>{{ (goal.current_progress / goal.target_amount * 100)|round(2) }}%</span>
                                            </div>
                                            <div class="progress">
                                                <div class="progress-bar" 
                                                    role="progressbar" 
                                                    style="width: {{ (goal.current_progress / goal.target_amount * 100)|round(2) }}%">
                                                </div>
                                            </div>
                                            <small class="text-muted d-block mt-1">
                                                {{ "%.2f"|format(goal.current_progress|float) }} / 
                                                {{ "%.2f"|format(goal.target_amount|float) }}‚ÇΩ
                                            </small>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ª–µ–π</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

        {% else %}
            <div class="alert alert-info text-center">
                <h4 class="alert-heading">üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</h4>
                <hr>
                <p class="mb-0">
                    –ù–∞—á–Ω–∏—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —Å—á–µ—Ç–∞ –∏ —Ü–µ–ª–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.<br>
                    <a href="{{ url_for('main.add_transaction') }}" class="btn btn-primary mt-3">
                        –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                    </a>
                </p>
            </div>
        {% endif %}
    </div>

    {% if has_data %}
        <script src="{{ url_for('static', filename='js/analytics-charts.js') }}"></script>
    {% endif %}
{% endblock %}